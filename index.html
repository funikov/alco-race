<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Эвакуация — Classic & Groovy</title>

  <!-- Шрифты -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fredoka:wght@400;600;800&family=Monoton&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0b0f1d; --bg2:#0f172a;
      --border:rgba(148,163,184,.16);
      --muted:#94a3b8; --text:#e5e7eb;
      --brand:#f97316; --brand2:#fb7185;
      --barStart: var(--brand); --barEnd: var(--brand2);
      --shadow:0 20px 40px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:Inter, Fredoka, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 900px at 10% -10%, #2a0b0b66, transparent 40%),
        radial-gradient(900px 700px at 120% 10%, #5d220a55, transparent 50%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }
    body[data-theme="groovy"]{
      --bg1:#120019; --bg2:#03041c; --border:rgba(255,255,255,.14);
      --muted:#b8c4ff; --text:#f6f7ff; --brand:#ffd166; --brand2:#ff6ad5;
      --barStart:#ffd166; --barEnd:#ff6ad5; --shadow:0 30px 60px rgba(0,0,0,.45); --radius:20px;
      font-family:Fredoka, Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
    }
    body[data-theme="groovy"]::before{
      content:""; position:fixed; inset:-10% -10%; z-index:-1; pointer-events:none;
      background:
        conic-gradient(from 0deg at 30% 30%, #ff6ad533, #ffd16633, #7df9ff33, #ff8fab33, #a78bfa33, #ff6ad533),
        conic-gradient(from 180deg at 70% 60%, #ffd16624, #7df9ff24, #ff6ad524, #a78bfa24, #ffd16624);
      filter:hue-rotate(0deg) saturate(140%) blur(.2px);
      animation: swirl 28s linear infinite; mix-blend-mode: screen;
    }
    @keyframes swirl{0%{transform:rotate(0) scale(1.02)}50%{transform:rotate(180deg) scale(1.04)}100%{transform:rotate(360deg) scale(1.02)}}

    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 18px;background:rgba(8,14,28,.55);backdrop-filter:blur(12px) saturate(120%);border-bottom:1px solid var(--border)}
    .brand{display:flex;gap:12px;align-items:center}
    .drop{width:32px;height:32px;border-radius:10px;background:
        radial-gradient(circle at 25% 25%, #fff8, transparent 35%),
        conic-gradient(from 220deg, var(--brand), var(--brand2), var(--brand));
      box-shadow:inset 0 0 14px #fff3, 0 8px 22px rgba(249,115,22,.35), 0 0 0 2px #ffffff22;}
    body[data-theme="groovy"] .drop{ width:38px;height:38px;border-radius:12px; animation:bob 3.8s ease-in-out infinite;}
    @keyframes bob{0%,100%{ transform:translateY(0) rotate(12deg)} 50%{ transform:translateY(-2px) rotate(8deg)}}
    .title{font-weight:800} body[data-theme="groovy"] .title{font-family:Monoton,cursive;letter-spacing:1px;font-size:28px;text-shadow:0 2px 8px #0009}
    .subtitle{font-size:12px;color:var(--muted)} .row{display:flex;gap:12px;align-items:center}
    .seg{display:inline-flex;gap:4px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:12px;padding:4px}
    .seg .segbtn{background:transparent;color:var(--text);border:0;padding:8px 12px;cursor:pointer;border-radius:10px;font-weight:800}
    .seg .segbtn.active{background:linear-gradient(180deg, rgba(249,115,22,.24), rgba(251,113,133,.18));}
    .btn{border:0;color:#06111c;background:linear-gradient(180deg, var(--brand) 0%, var(--brand2) 86%);
      padding:10px 16px;border-radius:999px;cursor:pointer;font-weight:800;letter-spacing:.3px;box-shadow:0 6px 16px rgba(249,115,22,.35);transition:transform .08s ease, filter .2s ease}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}

    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .grid.two-col{display:grid;gap:18px;align-items:stretch}
    #achCard{grid-area: ach;} #myDayCard{grid-area: day;} #lbCard{grid-area: lb;} #insightsCard{grid-area: insights;} #donutCard{grid-area: donut;}
    @media(max-width:960px){.grid.two-col{grid-template-columns:1fr;grid-template-areas:"day" "lb" "insights" "donut" "ach";}}
    @media (min-width: 961px){.grid.two-col{grid-template-columns:1.1fr .9fr;grid-template-areas:"day lb" "insights donut" "ach ach";}}

    .card{position:relative;overflow:clip;background:linear-gradient(180deg, rgba(251,113,133,.06), #070b18);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; isolation:isolate;}
    .card::before{content:""; position:absolute; inset:-30% -10% auto auto; width:200px;height:200px; border-radius:50%;
      background:repeating-radial-gradient(circle at 50% 50%, #ffffff06 0px, #ffffff06 2px, transparent 3px, transparent 5px),
        conic-gradient(from 0deg, #ff6ad5, var(--brand), #ffd166, var(--brand2), #a78bfa, #ff6ad5);
      filter:blur(18px) saturate(120%); opacity:.20; pointer-events:none; transform:rotate(-8deg); z-index:-1;}
    h2{margin:0 0 10px 0;font-size:20px} .stat{display:flex;align-items:baseline;gap:10px}.stat .big{font-size:44px;font-weight:900;letter-spacing:.3px}
    .unit{color:var(--muted)} .muted{color:var(--muted);font-size:13px}
    .chipbar{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 10px}
    .chip{border:1px dashed rgba(148,163,184,.6); color:var(--text); background:linear-gradient(180deg, #111829, #0c1426);
      padding:10px 14px;border-radius:12px;cursor:pointer;transition:border-color .2s ease, transform .08s ease, filter .2s ease; box-shadow:inset 0 0 0 1px #ffffff10}
    .chip:hover{border-color:rgba(255,255,255,.4)} .chip:active{transform:translateY(1px)}

    .bev-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:8px 0 14px}
    @media(max-width:520px){.bev-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .bev{position:relative; display:grid;place-items:center;gap:6px; padding:12px 8px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(180deg,#192238,#0c1222); cursor:pointer;text-align:center;transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease; box-shadow:inset 0 0 0 1px #ffffff10}
    .bev:hover{border-color:rgba(255,255,255,.4)} .bev.selected{border-color:rgba(255,209,102,.9); box-shadow:0 0 0 2px rgba(255,209,102,.25) inset}
    .bev .icon{width:28px;height:28px} .bev .name{font-size:12px;color:var(--text)}

    .progress-wrap{display:flex;gap:18px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .progress{position:relative;width:130px;height:130px}
    .progress svg{width:130px;height:130px;transform:rotate(-90deg)}
    .progress .ring-bg{stroke:rgba(148,163,184,.18);stroke-width:12;fill:none}
    .progress .ring-fg{stroke:url(#ringGradient);stroke-linecap:round;stroke-width:12;fill:none;transition:stroke-dashoffset .5s ease}
    .progress .inside{position:absolute;inset:0;display:grid;place-items:center;text-align:center}
    .progress .inside .big{font-weight:900;font-size:18px;display:inline-block;white-space:nowrap;transform-origin:center center}

    .goal-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=number]{width:120px;background:#0a0f1d;color:var(--text);border:1px solid rgba(148,163,184,.4);border-radius:12px;padding:10px 12px}

    .hidden{display:none!important}
    #splashLayer{position:fixed;inset:0;pointer-events:none;z-index:9999}
    .splash-particle{position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, var(--brand2), var(--brand) 60%);opacity:.95;filter:drop-shadow(0 6px 16px rgba(249,115,22,.35));animation:splash 720ms ease-out forwards}
    .splash-ripple{position:absolute;width:12px;height:12px;border:2px solid rgba(251,113,133,.8);border-radius:50%;transform:translate(-50%,-50%) scale(.2);opacity:.9;animation:ripple 650ms ease-out forwards}
    @keyframes splash{0%{transform:translate(0,0) scale(.85);opacity:.95}80%{opacity:1}100%{transform:translate(var(--dx), var(--dy)) scale(.2);opacity:0}}
    @keyframes ripple{to{transform:translate(-50%,-50%) scale(4.2);opacity:0}}

    .hour-wrap{display:flex;gap:8px;align-items:flex-end}
    .y-axis{position:relative;height:140px;width:56px;margin-top:8px}
    .y-axis .ylabel{position:absolute;left:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);writing-mode:vertical-rl;transform:rotate(180deg)}
    .yticks{position:absolute;right:0;top:0;bottom:0;display:flex;flex-direction:column;justify-content:space-between;align-items:flex-end;font-size:11px;color:var(--muted)}
    .yticks .tick{line-height:1}
    .hour-chart{position:relative;flex:1;display:flex;gap:4px;align-items:flex-end;height:140px;margin-top:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0b1220}
    .hgrid{position:absolute;inset:10px;pointer-events:none}
    .hgrid .line{position:absolute;left:0;right:0;height:1px;background:rgba(148,163,184,.22)}
    .hour-bar{flex:1;min-width:0;height:8px;border-radius:8px 8px 0 0;background:linear-gradient(180deg, var(--barStart), var(--barEnd) 80%), linear-gradient(0deg, #ffffffaa, #ffffff00);box-shadow:0 6px 16px rgba(249,115,22,.25);transition:height .35s ease, filter .2s ease}
    .hour-bar:hover{filter:saturate(120%)} .hour-axis{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}

    .ach-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:8px}
    @media(max-width:520px){.ach-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .ach{display:grid;place-items:center;gap:8px;padding:12px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#11192d,#0d1426);text-align:center;}
    .ach.locked{opacity:.65;filter:grayscale(.15) brightness(.95)}
    .ach-title{font-size:12px;font-weight:700} .ach-sub{font-size:11px;color:var(--muted)}
    .ach-ill{width:56px;height:56px;border-radius:12px;overflow:hidden;background:#0b0d24;border:1px solid var(--border);display:grid;place-items:center}
    .ach-ill svg{width:46px;height:46px}

    .donut-wrap{position:relative;display:grid;grid-template-columns:auto 1fr;gap:14px}
    @media(max-width:520px){ .donut-wrap{grid-template-columns:1fr} }
    #donutCanvas{width:260px;height:260px;border-radius:12px;background:#0b0d24;border:1px solid var(--border)}
    .donut-center{position:absolute;left:0;top:0;width:260px;height:260px;display:grid;place-items:center;pointer-events:none}
    .donut-center .big{font-weight:900;font-size:18px}
    .legend{display:flex;flex-direction:column;gap:8px;align-self:center}
    .legend-item{display:flex;align-items:center;gap:10px;font-size:14px}
    .legend-dot{width:10px;height:10px;border-radius:50%}
    .legend-sub{color:var(--muted);font-size:12px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:10000}
    .modal{width:min(880px,92vw);max-height:80vh;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,.16);text-align:right}
    .table th:first-child,.table td:first-child{text-align:left}
    .tfoot td{font-weight:800}

    .banner{margin-top:8px;font-size:12px;color:#eab308}
  </style>
</head>
<body data-theme="classic">
  <header>
    <div class="brand">
      <div class="drop" aria-hidden="true"></div>
      <div>
        <div class="title">Эвакуация</div>
        <div class="subtitle"><span id="themeLabel">Classic</span> — считаем чистый спирт, шутим ответственно 🍻</div>
      </div>
    </div>

    <div class="row" id="authRow" style="gap:10px;flex-wrap:wrap">
      <div class="seg" role="tablist" aria-label="Theme">
        <button class="segbtn active" id="themeClassicBtn" data-theme-btn="classic" role="tab" aria-selected="true">Classic</button>
        <button class="segbtn" id="themeGroovyBtn" data-theme-btn="groovy" role="tab" aria-selected="false">Groovy</button>
      </div>

      <div class="row hidden" id="userInfo">
        <div class="avatar" id="userAvatar" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name" id="userName"></div>
      </div>
      <button class="btn" id="signInBtn">Войти через Google</button>
      <button class="btn secondary hidden" id="signOutBtn">Выйти</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <div class="grid two-col">
      <!-- Мой вечер -->
      <section class="card" id="myDayCard" aria-labelledby="myDayTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="myDayTitle">Мой вечер</h2>
          <div class="muted" id="todayLabel"></div>
        </div>

        <div class="bev-grid" id="bevGrid" aria-label="Выбор напитка"></div>
        <div class="muted" id="factorHint"></div>

        <svg width="0" height="0" style="position:absolute">
          <defs>
            <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop id="rgStop1" offset="0%" stop-color="#f97316"/>
              <stop id="rgStop2" offset="50%" stop-color="#fb7185"/>
              <stop id="rgStop3" offset="100%" stop-color="#fb7185"/>
            </linearGradient>
          </defs>
        </svg>

        <div class="progress-wrap">
          <div class="progress" aria-label="Прогресс к лимиту">
            <svg viewBox="0 0 130 130" aria-hidden="true">
              <circle class="ring-bg" cx="65" cy="65" r="52" />
              <circle class="ring-fg" id="limitFg" cx="65" cy="65" r="52" stroke-dasharray="327" stroke-dashoffset="327" />
            </svg>
            <div class="inside">
              <div class="inside-center" style="text-align:center">
                <div class="big" id="limitCurrent">0 / 40 мл</div>
                <div class="muted" id="limitSub">лимит • ~0.0 SD</div>
              </div>
            </div>
          </div>
          <div>
            <div class="stat" aria-live="polite">
              <div class="big" id="myTotalPureMl">0</div>
              <div class="unit">мл чистого спирта</div>
            </div>
            <div class="muted" id="myRawTotal" style="margin-top:4px">Общий объём: 0.0 л • ~0.0 SD</div>
            <div class="goal-controls" style="margin-top:10px">
              <label for="limitInput" class="muted">Лимит на день:</label>
              <input id="limitInput" type="number" min="0" max="500" step="5" placeholder="мл" />
              <span class="muted">мл спирта</span>
              <button class="btn secondary" id="saveLimitBtn" title="Сохранить лимит">Сохранить</button>
            </div>
            <div class="hint banner">Шутим — но помним о безопасности: вода, перекусы и такси 🚕</div>
          </div>
        </div>

        <div class="chipbar" aria-label="Быстро добавить">
          <button class="chip" data-add="30">+ шот (30 мл)</button>
          <button class="chip" data-add="40">+ шот (40 мл)</button>
          <button class="chip" data-add="50">+ шот (50 мл)</button>
          <button class="chip" data-add="150">+ бокал (150 мл)</button>
          <button class="chip" data-add="330">+ бутылка (330 мл)</button>
          <button class="chip" data-add="500">+ бутылка (500 мл)</button>
          <button class="chip" data-add="568">+ пинта (568 мл)</button>
        </div>

        <div class="custom-add" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <input id="customInput" type="number" min="1" step="1" placeholder="Объём, мл" />
          <input id="customAbv" type="number" min="0" max="100" step="0.5" placeholder="Крепость, %" />
          <button class="btn" id="addCustomBtn">Добавить</button>
          <button class="btn secondary" id="undoBtn" title="Отменить последнее">Отменить</button>
        </div>
        <div class="muted" style="margin-top:6px">Можно добавлять отрицательные значения (например, -50) для коррекции. Для кастомного напитка можно указать крепость.</div>
      </section>

      <!-- Лидерборд -->
      <section class="card" id="lbCard" aria-labelledby="lbTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="lbTitle">Таблица лидеров</h2>
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <div class="tabs" role="tablist">
              <button class="segbtn tab active" data-scope="day" role="tab" aria-selected="true">День</button>
              <button class="segbtn tab" data-scope="month" role="tab" aria-selected="false">Месяц</button>
              <button class="segbtn tab" data-scope="year" role="tab" aria-selected="false">Год</button>
            </div>
            <button class="btn secondary" id="openMonthDailyBtn" title="Показать таблицу по дням месяца">Дни месяца</button>
          </div>
        </div>
        <div class="muted" id="periodLabel" style="margin:8px 0 12px;"></div>
        <div class="lb-list" id="lbList" aria-live="polite"></div>
        <div class="muted" style="margin-top:6px">
          Рейтинг по чистому спирту (мл). <strong>Что такое SD?</strong>
          SD = «стандартная доза» алкоголя. 1 SD — это 10 граммов чистого спирта.
          Мы считаем так: граммы = мл спирта × 0.789 (плотность этанола), а затем SD ≈ граммы / 10.
          То есть 1 SD ≈ 12.7 мл чистого спирта.
        </div>
      </section>

      <!-- Аналитика -->
      <section class="card" id="insightsCard" aria-labelledby="insightsTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="insightsTitle">Аналитика сегодня</h2>
          <div class="muted">по чистому спирту</div>
        </div>

        <div class="muted" style="margin-top:6px">Поступления по часам (сегодня)</div>
        <div class="hour-wrap">
          <div class="y-axis">
            <div class="ylabel">мл спирта</div>
            <div id="yTicks" class="yticks"></div>
          </div>
          <div id="hourChart" class="hour-chart" aria-label="График по часам"></div>
        </div>
        <div class="hour-axis"><span>0</span><span>6</span><span>12</span><span>18</span><span>24</span></div>
        <div id="hourEmpty" class="muted" style="margin-top:8px;text-align:center;display:none;">Пока нет добавлений за сегодня</div>
      </section>

      <!-- Пончик -->
      <section class="card" id="donutCard" aria-labelledby="donutTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="donutTitle">Состав вечера (сегодня)</h2>
          <div class="muted">по чистому спирту</div>
        </div>

        <div class="donut-wrap" style="margin-top:6px">
          <div style="position:relative">
            <canvas id="donutCanvas" width="260" height="260" aria-label="Диаграмма по напиткам"></canvas>
            <div class="donut-center">
              <div style="text-align:center">
                <div class="big" id="donutTotal">0 мл</div>
                <div class="muted" style="font-size:12px">сегодня</div>
              </div>
            </div>
          </div>
          <div class="legend" id="donutLegend"></div>
        </div>

        <div id="donutEmpty" class="muted" style="margin-top:8px;text-align:center;display:none;">Пока нет данных за сегодня</div>
      </section>

      <!-- Ачивки -->
      <section class="card" id="achCard" aria-labelledby="achTitle">
        <div class="row" style="justify-content: space-between; align-items: baseline; gap: 8px;">
          <h2 id="achTitle">Ачивки</h2>
          <div class="muted" id="achHint">дневные обновляются каждый день</div>
        </div>
        <div id="achievements" class="ach-grid"></div>
      </section>
    </div>
  </main>

  <footer style="max-width:1100px;margin:26px auto 60px;padding:0 16px;" class="muted">
    Шутливое приложение. Пейте ответственно. Один HTML-файл, Firebase + Firestore.
  </footer>

  <template id="lbRowTpl">
    <div class="lb-item" style="display:grid;grid-template-columns:28px 1fr auto;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(148,163,184,.22)">
      <div class="muted rank"></div>
      <div class="row" style="gap:10px; overflow:hidden;">
        <div class="avatar av" style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#0a0f1d"></div>
        <div class="name nm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
      </div>
      <div class="amt am" style="font-weight:800"></div>
    </div>
  </template>

  <!-- Модалка "дни месяца" -->
  <div id="monthModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="monthTitle">
    <div class="modal">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div id="monthTitle" style="font-weight:800;font-size:18px">Месяц по дням</div>
          <div class="muted" id="monthSubTitle"></div>
        </div>
        <button class="btn secondary" id="monthCloseBtn">Закрыть</button>
      </div>
      <div style="overflow:auto;">
        <table class="table" id="monthTable">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Чистый спирт, мл</th>
              <th>Объём, л</th>
              <th>К лимиту</th>
            </tr>
          </thead>
          <tbody id="monthTableBody"></tbody>
          <tfoot>
            <tr class="tfoot">
              <td>Итого</td>
              <td id="sumPure">0</td>
              <td id="sumTotal">0</td>
              <td id="sumShare">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <div id="splashLayer"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, writeBatch, collection, onSnapshot, orderBy, limit, query, getDocs, increment, where, collectionGroup, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCnoxLZYkISwWWm8z2H_lhzfCj6lscQxUY",
      authDomain: "hydro-race.firebaseapp.com",
      projectId: "hydro-race",
      storageBucket: "hydro-race.firebasestorage.app",
      messagingSenderId: "644586947662",
      appId: "1:644586947662:web:ab1910e37b809a54616f1f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    setPersistence(auth, browserLocalPersistence).catch(console.warn);
    getRedirectResult(auth).catch(()=>{});

    /* ==== Темы ==== */
    const themeClassicBtn = document.getElementById('themeClassicBtn');
    const themeGroovyBtn  = document.getElementById('themeGroovyBtn');
    const themeLabelEl    = document.getElementById('themeLabel');
    let currentTheme = null;
    function setThemeButtons(theme){
      themeClassicBtn.classList.toggle('active', theme==='classic');
      themeGroovyBtn.classList.toggle('active', theme==='groovy');
      themeClassicBtn.setAttribute('aria-selected', theme==='classic' ? 'true':'false');
      themeGroovyBtn.setAttribute('aria-selected', theme==='groovy' ? 'true':'false');
      themeLabelEl.textContent = theme==='groovy' ? 'Groovy' : 'Classic';
    }
    function updateRingGradient(theme){
      const s1=document.getElementById('rgStop1'), s2=document.getElementById('rgStop2'), s3=document.getElementById('rgStop3');
      if (theme==='groovy'){ s1.setAttribute('stop-color','#ffd166'); s2.setAttribute('stop-color','#ff6ad5'); s3.setAttribute('stop-color','#7df9ff'); }
      else { s1.setAttribute('stop-color','#f97316'); s2.setAttribute('stop-color','#fb7185'); s3.setAttribute('stop-color','#fb7185'); }
    }
    async function applyTheme(theme, source='local'){
      if (theme!=='classic' && theme!=='groovy') theme='classic';
      if (currentTheme===theme) return;
      document.body.setAttribute('data-theme', theme);
      currentTheme = theme;
      setThemeButtons(theme);
      updateRingGradient(theme);
      try{ localStorage.setItem('theme_alc', theme); }catch{}
      const user = auth.currentUser;
      if (user && source!=='remote'){
        try{ await setDoc(doc(db,'users',user.uid), { theme_alc: theme }, { merge:true }); }catch(e){}
      }
    }
    applyTheme((()=>{ try{ return localStorage.getItem('theme_alc'); }catch{return null;}})() || 'classic', 'local');
    themeClassicBtn.addEventListener('click', ()=>applyTheme('classic'));
    themeGroovyBtn.addEventListener('click', ()=>applyTheme('groovy'));

    /* ==== Авторизация ==== */
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn= document.getElementById('signOutBtn');
    const userInfoEl= document.getElementById('userInfo');
    const userNameEl= document.getElementById('userName');
    const userAvatarEl=document.getElementById('userAvatar');
    const appEl     = document.getElementById('app');

    const provider = new GoogleAuthProvider(); provider.setCustomParameters({ prompt:'select_account' });
    signInBtn.addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, provider); }
      catch(e){ if (e?.code==='auth/operation-not-supported-in-this-environment' || e?.code==='auth/popup-blocked'){ await signInWithRedirect(auth, provider); } else { alert('Ошибка входа: '+(e?.message||e)); } }
    });
    signOutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

    const todayLabelEl = document.getElementById('todayLabel');
    todayLabelEl.textContent = `Сегодня: ${new Date().toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short', year:'numeric'})}`;

    /* ==== Напитки ==== */
    const ICONS = {
      beer_light:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="8" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M17 10h1a3 3 0 0 1 0 6h-1" stroke="currentColor" stroke-width="1.5"/><path d="M7 8c0-2 2-3 5-3s5 1 5 3" stroke="currentColor" stroke-width="1.5"/></svg>`,
      beer_strong:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="7" width="10" height="13" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M16 9h1a3 3 0 0 1 0 6h-1" stroke="currentColor" stroke-width="1.5"/></svg>`,
      wine_white:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 3h10v4a5 5 0 0 1-5 5 5 5 0 0 1-5-5V3Z" stroke="currentColor" stroke-width="1.5"/><path d="M12 12v6M9 18h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      wine_red:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 4h10v3a5 5 0 0 1-5 5 5 5 0 0 1-5-5V4Z" stroke="currentColor" stroke-width="1.5"/><path d="M12 12v6M9 18h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      sparkling:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 3h8l-1 4v12a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V7L8 3Z" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="10" r="1" fill="currentColor"/><circle cx="12" cy="13" r="1" fill="currentColor"/></svg>`,
      cider:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="7" y="3" width="10" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M9 6h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      vodka:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M10 9h4v10a2 2 0 0 1-2 2 2 2 0 0 1-2-2V9Z" stroke="currentColor" stroke-width="1.5"/></svg>`,
      whisky:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="5" width="12" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M6 9h12" stroke="currentColor" stroke-width="1.5"/></svg>`,
      rum:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 3h6l-1 4v12a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2V7L9 3Z" stroke="currentColor" stroke-width="1.5"/></svg>`,
      gin:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="3" width="8" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 7h8" stroke="currentColor" stroke-width="1.5"/></svg>`,
      tequila:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="6" width="8" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M9 6h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      liqueur:`<svg viewBox="0 0 24 24" class="icon" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="7" y="4" width="10" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M9 8h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      shot_40:`<svg viewBox="0 0 24 24" class="icon" fill="none"><path d="M7 4h10l-1 5-2 10a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2L8 9 7 4Z" stroke="currentColor" stroke-width="1.5"/></svg>`,
      shot_tequila:`<svg viewBox="0 0 24 24" class="icon" fill="none"><path d="M7 4h10l-1 5-2 10a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2L8 9 7 4Z" stroke="currentColor" stroke-width="1.5"/><path d="M9 7h6" stroke="currentColor" stroke-width="1.5"/></svg>`,
      shot_absinthe:`<svg viewBox="0 0 24 24" class="icon" fill="none"><path d="M7 4h10l-1 5-2 10a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2L8 9 7 4Z" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="10" r="1" fill="currentColor"/></svg>`,
      shot_sambuca:`<svg viewBox="0 0 24 24" class="icon" fill="none"><path d="M7 4h10l-1 5-2 10a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2L8 9 7 4Z" stroke="currentColor" stroke-width="1.5"/><path d="M12 6v3" stroke="currentColor" stroke-width="1.5"/></svg>`
    };

    const ALC_BEVERAGES = [
      { key:'beer_light', name:'Лагер',         abv: 4.5 },
      { key:'beer_strong',name:'IPA',           abv: 6.5 },
      { key:'wine_white', name:'Вино белое',    abv: 11.5 },
      { key:'wine_red',   name:'Вино красное',  abv: 13.5 },
      { key:'sparkling',  name:'Игристое',      abv: 12.0 },
      { key:'cider',      name:'Сидр',          abv: 5.0 },
      { key:'vodka',      name:'Водка',         abv: 40.0 },
      { key:'whisky',     name:'Виски',         abv: 40.0 },
      { key:'rum',        name:'Ром',           abv: 40.0 },
      { key:'gin',        name:'Джин',          abv: 40.0 },
      { key:'tequila',    name:'Текила',        abv: 38.0 },
      { key:'liqueur',    name:'Ликёр',         abv: 20.0 },
      { key:'shot_40',    name:'Шот (40%)',     abv: 40.0 },
      { key:'shot_tequila',name:'Шот текилы',    abv: 38.0 },
      { key:'shot_absinthe',name:'Шот абсента',  abv: 70.0 },
      { key:'shot_sambuca',name:'Шот самбуки',   abv: 38.0 },
    ];
    const BEV_BY_KEY = Object.fromEntries(ALC_BEVERAGES.map(b=>[b.key,b]));

    const bevGrid = document.getElementById('bevGrid');
    const factorHintEl = document.getElementById('factorHint');
    let currentBevKey = 'beer_light';

    function renderBeverages(){
      bevGrid.innerHTML = '';
      ALC_BEVERAGES.forEach(b => {
        const btn = document.createElement('button');
        btn.className='bev'+(b.key===currentBevKey?' selected':'');
        btn.type='button'; btn.dataset.key=b.key;
        btn.innerHTML = `${ICONS[b.key]||''}<div class="name">${b.name}</div>`;
        const ic = btn.querySelector('.icon'); if (ic) ic.style.color = b.abv>=30 ? '#ffd166' : '#fb7185';
        btn.addEventListener('click', ()=>{ currentBevKey=b.key; updateFactorHint(); renderBeverages(); });
        bevGrid.appendChild(btn);
      });
    }
    function updateFactorHint(){
      const bev = ALC_BEVERAGES.find(b=>b.key===currentBevKey);
      factorHintEl.textContent = `Сейчас: ${bev.name} — крепость ~${bev.abv}% (чистого спирта на 100 мл: ${Math.round(bev.abv)} мл)`;
    }

    /* ==== Дата-хелперы ==== */
    const pad=(n)=>String(n).padStart(2,'0');
    const keysFor=(date=new Date())=>({ dateStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`, monthStr:`${date.getFullYear()}-${pad(date.getMonth()+1)}`, yearStr:`${date.getFullYear()}` });

    /* ==== Лимит/прогресс ==== */
    const limitFg = document.getElementById('limitFg');
    const limitCurrent = document.getElementById('limitCurrent');
    const limitSub     = document.getElementById('limitSub');
    const limitInput   = document.getElementById('limitInput');
    const saveLimitBtn = document.getElementById('saveLimitBtn');
    let currentLimitPureMl = 40; // по умолчанию 40 мл чистого спирта
    const CIRC = 2 * Math.PI * 52;

    const grams = (pure_ml)=> pure_ml * 0.789;
    const sd = (pure_ml)=> grams(pure_ml) / 10;

    function setRingProgress(ratio){ const clamped = Math.max(0, Math.min(1, ratio || 0)); limitFg.setAttribute('stroke-dasharray', String(CIRC)); limitFg.setAttribute('stroke-dashoffset', String(CIRC * (1 - clamped))); }
    function updateProgressUI(pure_ml){
      const limit = Math.max(0, currentLimitPureMl || 0);
      const ratio = limit > 0 ? pure_ml / limit : 0;
      setRingProgress(ratio);
      const cur = Math.round(pure_ml);
      const lim = Math.round(limit);
      const sds = sd(pure_ml).toFixed(1);
      limitCurrent.textContent = `${cur} / ${lim} мл`;
      limitSub.textContent = `лимит • ~${sds} SD`;
    }

    /* ==== Быстрое добавление ==== */
    const addChips = Array.from(document.querySelectorAll('[data-add]'));
    const customInput = document.getElementById('customInput');
    const customAbv   = document.getElementById('customAbv');
    const addCustomBtn= document.getElementById('addCustomBtn');
    const undoBtn     = document.getElementById('undoBtn');

    /* ==== Подборки ==== */
    const myTotalPureMlEl = document.getElementById('myTotalPureMl');
    const myRawTotalEl    = document.getElementById('myRawTotal');

    /* ==== Таб-лидерборд ==== */
    const lbListEl = document.getElementById('lbList');
    const periodLabelEl = document.getElementById('periodLabel');
    const tabs = Array.from(document.querySelectorAll('.tab'));

    /* ==== Пончиковая и график ==== */
    const donutCanvas = document.getElementById('donutCanvas');
    const donutLegend = document.getElementById('donutLegend');
    const donutEmpty  = document.getElementById('donutEmpty');
    const donutTotalEl= document.getElementById('donutTotal');
    const donutCard   = document.getElementById('donutCard');
    const insightsCard= document.getElementById('insightsCard');

    const hourChart = document.getElementById('hourChart');
    const hourEmpty = document.getElementById('hourEmpty');
    const yTicksEl  = document.getElementById('yTicks');
    let hourData = new Array(24).fill(0); // чистый спирт/час
    let compMap  = Object.create(null);   // key -> чистый спирт

    /* ==== Брызги ==== */
    const splashLayer = document.getElementById('splashLayer');
    function splashAt(x,y,opts={}){ const count = opts.count || 14; for(let i=0;i<count;i++){ const p=document.createElement('div'); p.className='splash-particle'; const angle=Math.random()*Math.PI*2; const dist=40+Math.random()*70; const dx=Math.cos(angle)*dist; const dy=Math.sin(angle)*dist-10; const size=6+Math.random()*8; p.style.setProperty('--dx',dx+'px'); p.style.setProperty('--dy',dy+'px'); p.style.width=size+'px'; p.style.height=size+'px'; p.style.left=(x-size/2)+'px'; p.style.top=(y-size/2)+'px'; if (opts.neg){ p.style.background='radial-gradient(circle at 30% 30%, #fca5a5, #f87171 60%)'; p.style.filter='drop-shadow(0 6px 16px rgba(248,113,113,.25))'; } splashLayer.appendChild(p); p.addEventListener('animationend',()=>p.remove()); } const r=document.createElement('div'); r.className='splash-ripple'; r.style.left=x+'px'; r.style.top=y+'px'; if (opts.neg){ r.style.borderColor='rgba(248,113,113,.7)'; } splashLayer.appendChild(r); r.addEventListener('animationend',()=>r.remove()); }
    function splashNearTotal(neg){ const el=document.getElementById('myTotalPureMl'); const rect=el.getBoundingClientRect(); splashAt(rect.left+rect.width/2, rect.top+rect.height/2, {neg:!!neg, count:10}); }

    /* ==== Ачивки (угарные) ==== */
    const badge = (color, text)=>`
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g>
        <circle cx="32" cy="32" r="22" fill="${color}" opacity=".9"/>
        <circle cx="32" cy="32" r="14" fill="#0b0d24" opacity=".28"/>
        <text x="32" y="37" text-anchor="middle" font-size="16" fill="#ffffff" font-family="Inter, Arial" font-weight="700">${text}</text>
      </g></svg>`;

    const ACH_DEFS = [
      // Дневные — объём/поведение
      { id:'warmup_10',        name:'Разогревчик',         desc:'≥10 мл спирта', daily:true,  icon: badge('#fb7185','10') },
      { id:'sd_2',             name:'Греется мотор',       desc:'≥2 SD за вечер', daily:true, icon: badge('#22d3ee','2SD') },
      { id:'sd_5',             name:'Ну ты жесть',         desc:'≥5 SD за вечер', daily:true, icon: badge('#a78bfa','5SD') },
      { id:'sniper_limit',     name:'Снайпер по лимиту',   desc:'В пределах ±5 мл от лимита', daily:true, icon: badge('#f59e0b','±5') },
      { id:'shot_master_5',    name:'Шотомёт',             desc:'≥5 шотов за вечер', daily:true, icon: badge('#f97316','×5') },
      { id:'beer_only',        name:'Пивной монах',        desc:'Только пиво сегодня', daily:true, icon: badge('#60a5fa','🍺') },
      { id:'mixologist_6',     name:'Алхимик-бармен',      desc:'≥6 типов напитков', daily:true, icon: badge('#ffd166','6+') },
      { id:'after_midnight',   name:'Полуночный рейд',     desc:'Добавление после 02:00', daily:true, icon: badge('#ef4444','02') },
      { id:'no_neg',           name:'Без откатов',         desc:'Ни одного минуса', daily:true, icon: badge('#84cc16','OK') },
      { id:'toast_10',         name:'Тостер-9000',         desc:'≥10 добавлений', daily:true, icon: badge('#ff8fab','×10') },
      { id:'limit_over',       name:'Пора на воду!',       desc:'Выше лимита', daily:true, icon: badge('#ef4444','!') },

      // Долгосрочные
      { id:'lifetime_1l',      name:'Алкоакадемик',        desc:'1 литр чистого спирта суммарно', daily:false, icon: badge('#22d3ee','1L') },
      { id:'lifetime_5l',      name:'Барный мудрец',       desc:'5 литров суммарно', daily:false, icon: badge('#60a5fa','5L') },
      { id:'lifetime_10l',     name:'Легенда бара',        desc:'10 литров суммарно', daily:false, icon: badge('#a78bfa','10L') },
    ];
    const ACH_SVGS = Object.fromEntries(ACH_DEFS.map(a=>[a.id,a.icon]));
    const DAILY_ACH_IDS = new Set(ACH_DEFS.filter(a=>a.daily).map(a=>a.id));

    const achGrid = document.getElementById('achievements');
    let unlockedAll = new Set();   // постоянные
    let unlockedToday = new Set(); // дневные

    function renderAchievements(){
      achGrid.innerHTML='';
      ACH_DEFS.forEach(a=>{
        const isDaily = DAILY_ACH_IDS.has(a.id);
        const has = isDaily ? unlockedToday.has(a.id) : unlockedAll.has(a.id);
        const el=document.createElement('div');
        el.className='ach'+(has?'':' locked');
        el.innerHTML=`<div class="ach-ill">${ACH_SVGS[a.id]||badge('#64748b','?')}</div>
          <div class="ach-title">${a.name}</div>
          <div class="ach-sub">${a.desc}${isDaily ? ' • сегодня' : ''}</div>`;
        achGrid.appendChild(el);
      });
    }

    let unsubMyDaily=null, unsubLB=null, unsubUserDoc=null, unsubAch=null, unsubIntakes=null;
    function cleanupSubscriptions(){
      if (unsubMyDaily){unsubMyDaily();unsubMyDaily=null}
      if (unsubLB){unsubLB();unsubLB=null}
      if (unsubUserDoc){unsubUserDoc();unsubUserDoc=null}
      if (unsubAch){unsubAch();unsubAch=null}
      if (unsubIntakes){unsubIntakes();unsubIntakes=null}
    }

    onAuthStateChanged(auth, async (user)=>{
      if (user){
        appEl.classList.remove('hidden');
        signInBtn.classList.add('hidden'); signOutBtn.classList.remove('hidden'); userInfoEl.classList.remove('hidden');
        userNameEl.textContent = user.displayName || user.email;
        userAvatarEl.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="Аватар" width="32" height="32"/>` : '';

        const userRef = doc(db, 'users', user.uid);
        await setDoc(userRef, { uid:user.uid, displayName:user.displayName||null, email:user.email||null, photoURL:user.photoURL||null, lastLoginAt:serverTimestamp(), createdAt:serverTimestamp() }, { merge:true });

        unsubUserDoc = onSnapshot(userRef, async (snap)=>{
          const d = snap.data() || {};
          if (d.theme_alc && (d.theme_alc==='classic' || d.theme_alc==='groovy')) applyTheme(d.theme_alc, 'remote');
          if (typeof d.alc_limit_pure_ml !== 'number'){ await setDoc(userRef, { alc_limit_pure_ml: 40 }, { merge:true }); currentLimitPureMl = 40; }
          else { currentLimitPureMl = Math.min(500, Math.max(0, Math.round(d.alc_limit_pure_ml))); }
          limitInput.value = String(currentLimitPureMl);
          updateProgressUI(lastPureMl);
        });

        renderBeverages(); updateFactorHint();
        subscribeMyDailyTotal();
        subscribeIntakesToday();
        renderHourChart();
        subscribeAchievements();
        activateTab('day');
      } else {
        appEl.classList.add('hidden');
        signInBtn.classList.remove('hidden'); signOutBtn.classList.add('hidden'); userInfoEl.classList.add('hidden');
        cleanupSubscriptions(); renderBeverages(); updateFactorHint();
      }
    });

    /* ==== Добавления ==== */
    addChips.forEach(btn=>btn.addEventListener('click',(e)=>{const ml=parseInt(btn.dataset.add,10); addAmount(ml); if(e && e.clientX!=null){ splashAt(e.clientX,e.clientY,{neg:ml<0}); }}));
    document.getElementById('addCustomBtn').addEventListener('click', ()=>{
      const v=parseInt(customInput.value,10);
      if (!Number.isFinite(v) || v===0){ alert('Введите объём (мл), не 0'); return; }
      const abvVal = parseFloat(customAbv.value);
      addAmount(v, Number.isFinite(abvVal) ? abvVal : null);
      const r = addCustomBtn.getBoundingClientRect(); splashAt(r.left+r.width/2, r.top+r.height/2, {neg:v<0});
      customInput.value=''; customAbv.value='';
    });
    document.getElementById('undoBtn').addEventListener('click', undoLast);

    async function addAmount(ml, customAbvPercent=null){
      const user=auth.currentUser; if(!user) return;
      const bev = ALC_BEVERAGES.find(b=>b.key===currentBevKey) || ALC_BEVERAGES[0];
      const abv = (customAbvPercent!=null) ? customAbvPercent : bev.abv;
      const pure_ml = Math.round(ml * (abv/100));
      const now = new Date(); const { dateStr, monthStr, yearStr } = keysFor(now);

      const batch = writeBatch(db);
      const intakeRef = doc(collection(db,'alc_intakes'));
      batch.set(intakeRef, { uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, ml, beverage:bev.key, beverage_name:bev.name, abv, pure_ml, ts:serverTimestamp(), dateStr, monthStr, yearStr });

      const base={ uid:user.uid, displayName:user.displayName||null, photoURL:user.photoURL||null, updatedAt:serverTimestamp(), dateStr, monthStr, yearStr };
      batch.set(doc(db,'daily_alc_totals',dateStr,'users',user.uid),   { ...base, total_ml: increment(ml), total_pure_ml: increment(pure_ml) }, { merge:true });
      batch.set(doc(db,'monthly_alc_totals',monthStr,'users',user.uid),{ ...base, total_ml: increment(ml), total_pure_ml: increment(pure_ml) }, { merge:true });
      batch.set(doc(db,'yearly_alc_totals',yearStr,'users',user.uid), { ...base, total_ml: increment(ml), total_pure_ml: increment(pure_ml) }, { merge:true });

      await batch.commit();
      splashNearTotal(ml<0);
    }

    async function undoLast(){
      const user=auth.currentUser; if(!user) return;
      const { dateStr } = keysFor(new Date());
      const qs = await getDocs(query(collection(db,'alc_intakes'), orderBy('ts','desc'), limit(50)));
      const mine = qs.docs.find(d=> d.data().uid===user.uid && d.data().dateStr===dateStr);
      if (!mine){ alert('Нечего отменять за сегодня'); return; }
      const data = mine.data();
      const batch = writeBatch(db);
      batch.set(doc(db,'daily_alc_totals',dateStr,'users',user.uid),   { total_ml: increment(-data.ml), total_pure_ml: increment(-(data.pure_ml||0)), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'monthly_alc_totals',data.monthStr,'users',user.uid),{ total_ml: increment(-data.ml), total_pure_ml: increment(-(data.pure_ml||0)), updatedAt:serverTimestamp() }, { merge:true });
      batch.set(doc(db,'yearly_alc_totals',data.yearStr,'users',user.uid), { total_ml: increment(-data.ml), total_pure_ml: increment(-(data.pure_ml||0)), updatedAt:serverTimestamp() }, { merge:true });
      await batch.commit();
    }

    /* ==== Лидерборд ==== */
    tabs.forEach(tab => {
      tab.addEventListener('click', () => activateTab(tab.dataset.scope));
      tab.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activateTab(tab.dataset.scope); } });
    });
    function activateTab(scope){
      tabs.forEach(t=>{ const a=t.dataset.scope===scope; t.classList.toggle('active',a); t.setAttribute('aria-selected',a?'true':'false'); });
      if (unsubLB){unsubLB();unsubLB=null;}
      const now = new Date(); const { dateStr, monthStr, yearStr } = keysFor(now);
      let colRef,label;
      if (scope==='day'){ colRef=collection(db,'daily_alc_totals',dateStr,'users'); label=`Сегодня — ${now.toLocaleDateString()}`; }
      else if (scope==='month'){ colRef=collection(db,'monthly_alc_totals',monthStr,'users'); label=`Месяц — ${now.toLocaleString(undefined,{month:'long',year:'numeric'})}`; }
      else { colRef=collection(db,'yearly_alc_totals',yearStr,'users'); label=`Год — ${yearStr}`; }
      periodLabelEl.textContent = label;
      unsubLB = onSnapshot(query(colRef, orderBy('total_pure_ml','desc'), limit(50)), (qs)=>renderLeaderboard(qs.docs.map(d=>d.data())));
    }
    function renderLeaderboard(items){
      lbListEl.innerHTML='';
      if (!items.length){ lbListEl.innerHTML='<div class="muted">Пока пусто. Будьте первым! 🍻</div>'; return; }
      const tpl = document.getElementById('lbRowTpl');
      items.forEach((it,i)=>{
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.rank').textContent = i+1;
        node.querySelector('.av').innerHTML = it.photoURL ? `<img src="${it.photoURL}" alt="Аватар" width="32" height="32"/>` : '';
        node.querySelector('.nm').textContent = it.displayName || 'Без имени';
        const sds = sd(Math.max(0,it.total_pure_ml||0)).toFixed(1);
        node.querySelector('.am').textContent = `${Math.round(Math.max(0,it.total_pure_ml||0))} мл спирта • ~${sds} SD`;
        lbListEl.appendChild(node);
      });
    }

    /* ==== График по часам ==== */
    function niceStep(max, target=4){
      if (!isFinite(max) || max<=0) return 10;
      const raw = max / target; const pow = Math.pow(10, Math.floor(Math.log10(raw)));
      const base = raw / pow; let mult = 1; if (base<=1) mult=1; else if (base<=2) mult=2; else if (base<=5) mult=5; else mult=10;
      let step = mult * pow; step = Math.max(5, Math.round(step/5)*5); return step;
    }
    function renderYAxis(niceMax, step){
      if (yTicksEl) {
        const ticks = []; for (let v = niceMax; v >= 0; v -= step) ticks.push(v);
        yTicksEl.innerHTML = ticks.map(v=>`<div class="tick">${v}</div>`).join('');
      }
      if (hourChart) {
        const inner = 120; const grid = document.createElement('div'); grid.className = 'hgrid';
        for (let v = 0; v <= niceMax; v += step) {
          const y = inner - Math.round((v/(niceMax||1)) * inner);
          const line = document.createElement('div'); line.className = 'line'; line.style.top = y + 'px';
          grid.appendChild(line);
        }
        hourChart.appendChild(grid);
      }
    }
    function renderHourChart(){
      hourChart.innerHTML='';
      const posSum = hourData.reduce((s,v)=> s + (v>0 ? v : 0), 0);
      hourEmpty.style.display = posSum > 0 ? 'none' : 'block';

      const maxPos = Math.max(1, ...hourData.map(v=>Math.max(0,v)));
      const step   = niceStep(maxPos, 4);
      const niceMax= Math.ceil(maxPos / step) * step;
      renderYAxis(niceMax || 10, step || 5);

      for(let i=0;i<24;i++){
        const bar=document.createElement('div'); bar.className='hour-bar';
        const val = Math.max(0, hourData[i]); // отрицательные не рисуем вниз
        const ratio = val / (niceMax || 1);
        bar.style.height = Math.max(8, Math.round(120*ratio))+'px';
        bar.title = `${i}:00 — ${Math.round(hourData[i])} мл спирта`;
        hourChart.appendChild(bar);
      }
      syncHeights();
    }

    /* ==== Пончик ==== */
    const PALETTE = ['#ffd166','#ff6ad5','#7df9ff','#f97316','#a78bfa','#ff8fab','#8aff80','#f5a3ff'];
    function drawDonut(){
      if (!donutCanvas) return;
      const dpr = window.devicePixelRatio || 1;
      const W = 260, H = 260;
      donutCanvas.width = W * dpr; donutCanvas.height = H * dpr;
      donutCanvas.style.width = W + 'px'; donutCanvas.style.height= H + 'px';
      const ctx = donutCanvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,W,H);

      const allEntries = Object.entries(compMap);
      const totalAll   = allEntries.reduce((s,[,v])=> s + v, 0);
      donutTotalEl.textContent = `${Math.round(totalAll)} мл`;

      const posEntries = allEntries.filter(([,v])=> v>0).sort((a,b)=> b[1]-a[1]);
      const totalPos   = posEntries.reduce((s,[,v])=> s + v, 0);

      donutLegend.innerHTML = '';
      const cx = W/2, cy = H/2, R = 100, r = 66;

      if (totalPos <= 0){
        ctx.globalAlpha = .18;
        ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.arc(cx,cy,r,Math.PI*2,0,true);
        ctx.closePath(); ctx.fillStyle = '#ffffff22'; ctx.fill(); ctx.globalAlpha = 1;
        allEntries.forEach(([key,val],i)=>{
          const bev = BEV_BY_KEY[key] || { name:key };
          const node = document.createElement('div');
          node.className = 'legend-item';
          node.innerHTML = `
            <div class="legend-dot" style="background:${PALETTE[i % PALETTE.length]}"></div>
            <div>
              <div>${bev.name}</div>
              <div class="legend-sub">${Math.round(val)} мл • —</div>
            </div>`;
          donutLegend.appendChild(node);
        });
        syncHeights();
        return;
      }

      let start = -Math.PI/2; const gap = 0.02;
      posEntries.forEach(([key,val],i)=>{
        const frac = val/totalPos; const ang = Math.max(0.04, frac*Math.PI*2) - gap; const end = start + ang;
        ctx.beginPath(); ctx.arc(cx,cy,R,start,end); ctx.arc(cx,cy,r,end,start,true); ctx.closePath();
        ctx.fillStyle = PALETTE[i % PALETTE.length]; ctx.fill(); start = end + gap;
      });

      allEntries.sort((a,b)=> b[1]-a[1]).forEach(([key,val],i)=>{
        const bev = BEV_BY_KEY[key] || { name:key };
        const pct = val > 0 ? Math.round((val/totalPos)*100)+'%' : '—';
        const node = document.createElement('div');
        node.className = 'legend-item';
        node.innerHTML = `
          <div class="legend-dot" style="background:${PALETTE[i % PALETTE.length]}"></div>
          <div>
            <div>${bev.name}</div>
            <div class="legend-sub">${Math.round(val)} мл • ${pct}</div>
          </div>`;
        donutLegend.appendChild(node);
      });

      syncHeights();
    }

    /* ==== Синхронизация высот карточек ==== */
    function syncHeights(){
      const desktop = window.matchMedia('(min-width: 961px)').matches;
      if (!desktop){ insightsCard.style.height=''; return; }
      requestAnimationFrame(()=>{ insightsCard.style.height = donutCard.offsetHeight + 'px'; });
    }
    window.addEventListener('resize', syncHeights);
    if ('ResizeObserver' in window){
      const ro = new ResizeObserver(syncHeights);
      ro.observe(donutCard); 
      ro.observe(insightsCard);
    }

    /* ==== Сегодняшние приёмы ==== */
    let todayIntakes = [];
    function subscribeIntakesToday(){
      if (unsubIntakes) unsubIntakes();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const qy = query(collection(db,'alc_intakes'), where('uid','==',uid), where('dateStr','==',dateStr));
      unsubIntakes = onSnapshot(qy, async (qs)=>{
        hourData = new Array(24).fill(0);
        compMap = Object.create(null);
        todayIntakes = [];
        qs.forEach(d=>{
          const it=d.data();
          const ts=it.ts?.toDate ? it.ts.toDate() : new Date();
          const h=(ts instanceof Date) ? ts.getHours() : 0;
          const ml = it.ml || 0;
          const pure = (it.pure_ml != null) ? it.pure_ml : Math.round(ml * ((it.abv||0)/100));
          if (h>=0 && h<24) hourData[h] += pure;
          const key = it.beverage || 'unknown';
          compMap[key] = (compMap[key]||0) + pure;
          todayIntakes.push({ ts, ml, pure_ml: pure, beverage: key, abv: it.abv||null });
        });
        renderHourChart();
        drawDonut();
        await checkAchievements(lastPureMl || hourData.reduce((a,b)=>a+b,0), todayIntakes);
      });
    }

    /* ==== Мой дневной итог ==== */
    let lastPureMl = 0;
    function subscribeMyDailyTotal(){
      if (unsubMyDaily) unsubMyDaily();
      const { dateStr } = keysFor(new Date());
      const uid = auth.currentUser?.uid; if (!uid) return;
      const ref = doc(db, 'daily_alc_totals', dateStr, 'users', uid);
      unsubMyDaily = onSnapshot(ref, async (snap)=>{
        const d = snap.exists()? snap.data() : { total_pure_ml:0, total_ml:0 };
        const pure = d.total_pure_ml || 0; const raw = d.total_ml || 0;
        lastPureMl = pure;
        myTotalPureMlEl.textContent = Math.round(pure);
        myRawTotalEl.textContent = `Общий объём: ${(raw/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})} л • ~${sd(pure).toFixed(1)} SD`;
        updateProgressUI(pure);
        await checkAchievements(pure, todayIntakes);
      });
    }

    /* ==== Ачивки ==== */
    function onSnapshotOnce(ref){ return new Promise((resolve)=>{ const unsub=onSnapshot(ref,(snap)=>{ resolve(snap); unsub(); },{includeMetadataChanges:false}); }); }
    function lifetimePure(uid){ return getDocs(query(collectionGroup(db,'users'), where('uid','==',uid))).then(s=>{ let sum=0; s.forEach(d=>{ const x=d.data(); if (x.yearStr && typeof x.total_pure_ml==='number') sum+=Math.max(0, x.total_pure_ml); }); return sum; }); }

    function subscribeAchievements(){
      if (unsubAch) unsubAch();
      const uid=auth.currentUser?.uid; if (!uid) return;
      const today = keysFor(new Date()).dateStr;
      unlockedAll = new Set(); unlockedToday = new Set();
      unsubAch = onSnapshot(collection(db,'users',uid,'alc_achievements'), (qs)=>{
        unlockedAll.clear(); unlockedToday.clear();
        qs.forEach(docSnap=>{
          const x = docSnap.data()||{};
          const baseId = x.id || null; if (!baseId) return;
          const isDaily = x.daily === true || DAILY_ACH_IDS.has(baseId);
          if (isDaily){ if (x.dateStr === today) unlockedToday.add(baseId); }
          else { unlockedAll.add(baseId); }
        });
        renderAchievements();
      });
    }

    const emittedAchDocIds = new Set();
    async function recordAchievement(id,payload={}){
      const uid=auth.currentUser?.uid; if (!uid) return;
      const isDaily = DAILY_ACH_IDS.has(id);
      const ds = payload.dateStr || keysFor(new Date()).dateStr;
      const docId = isDaily ? `${id}_${ds}` : id;
      if (emittedAchDocIds.has(docId)) return;
      emittedAchDocIds.add(docId);
      await setDoc(doc(db,'users',uid,'alc_achievements',docId), { id, daily:isDaily, dateStr: ds, unlockedAt: serverTimestamp(), ...payload }, { merge:true });
    }

    async function checkAchievements(todayPure, intakes = []){
      const user=auth.currentUser; if(!user) return;
      const userRef = doc(db,'users',user.uid);
      const uSnap = await onSnapshotOnce(userRef); const u = uSnap.data()||{};
      const limit = typeof u.alc_limit_pure_ml === 'number' ? u.alc_limit_pure_ml : 40;
      const todayStr = keysFor(new Date()).dateStr;

      // SD-уровни
      const totalSd = sd(todayPure);
      if (todayPure >= 10) await recordAchievement('warmup_10', { dateStr: todayStr });
      if (totalSd >= 2) await recordAchievement('sd_2', { dateStr: todayStr, sd: totalSd });
      if (totalSd >= 5) await recordAchievement('sd_5', { dateStr: todayStr, sd: totalSd });

      // Лимит
      if (limit>0 && Math.abs(todayPure - limit) <= 5 && todayPure>0) await recordAchievement('sniper_limit', { dateStr: todayStr, limit, delta_ml: Math.round(todayPure - limit) });
      if (todayPure > limit && limit>0) await recordAchievement('limit_over', { dateStr: todayStr, limit });

      // Поведение
      if (intakes.length){
        const shotCount = intakes.filter(it=>{
          const abv = it.abv || 0; const vol = Math.abs(it.ml||0);
          return it.beverage?.startsWith?.('shot') || (vol<=60 && abv>=30);
        }).length;
        if (shotCount >= 5) await recordAchievement('shot_master_5', { dateStr: todayStr, count: shotCount });

        const addsCount = intakes.length;
        if (addsCount >= 10) await recordAchievement('toast_10', { dateStr: todayStr, count: addsCount });

        const hasNegative = intakes.some(it=> (it.ml||0) < 0);
        if (!hasNegative && addsCount>0) await recordAchievement('no_neg', { dateStr: todayStr });

        const anyNight = intakes.some(it=> {
          const h = it.ts?.getHours?.() ?? 0;
          return h >= 2 && h < 5;
        });
        if (anyNight) await recordAchievement('after_midnight', { dateStr: todayStr });

        const positiveKeys = Object.entries(compMap).filter(([k,v])=> v>0).map(([k])=>k);
        if (positiveKeys.length >= 6) await recordAchievement('mixologist_6', { dateStr: todayStr, types: positiveKeys.length });

        const onlyBeer = positiveKeys.length>0 && positiveKeys.every(k=> k.startsWith('beer_'));
        if (onlyBeer) await recordAchievement('beer_only', { dateStr: todayStr });
      }

      // Долгосрочные
      const life = await lifetimePure(user.uid);
      if (life >= 1000)  await recordAchievement('lifetime_1l',  { total_pure_ml: life });
      if (life >= 5000)  await recordAchievement('lifetime_5l',  { total_pure_ml: life });
      if (life >= 10000) await recordAchievement('lifetime_10l', { total_pure_ml: life });
    }

    /* ==== Сохранение лимита ==== */
    document.getElementById('saveLimitBtn').addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return;
      const v = parseFloat(limitInput.value);
      if (!Number.isFinite(v) || v<0){ alert('Введите лимит в мл спирта'); return; }
      const clamped = Math.min(500, Math.max(0, Math.round(v)));
      await setDoc(doc(db,'users', user.uid), { alc_limit_pure_ml: clamped }, { merge:true });
      currentLimitPureMl = clamped; updateProgressUI(lastPureMl);
    });

    /* ==== Периоды/модалка месяца ==== */
    const monthModal      = document.getElementById('monthModal');
    const monthCloseBtn   = document.getElementById('monthCloseBtn');
    document.getElementById('openMonthDailyBtn').addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user) return;
      const now = new Date();
      const rows = await fetchMonthRowsSafe(user.uid, now.getFullYear(), now.getMonth());

      let sumP=0, sumT=0;
      const body = document.getElementById('monthTableBody');
      body.innerHTML = rows.map(r=>{
        sumP += r.total_pure_ml; sumT += r.total_ml;
        return `<tr>
          <td>${new Date(r.dateStr).toLocaleDateString(undefined,{day:'2-digit', month:'short', weekday:'short'})}</td>
          <td>${Math.round(r.total_pure_ml)}</td>
          <td>${(r.total_ml/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2})}</td>
          <td>${limitPct(r.total_pure_ml, currentLimitPureMl)}</td>
        </tr>`;
      }).join('');
      document.getElementById('sumPure').textContent = Math.round(sumP);
      document.getElementById('sumTotal').textContent = (sumT/1000).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:2});
      document.getElementById('sumShare').textContent = '—';

      document.getElementById('monthTitle').textContent = 'Месяц по дням';
      document.getElementById('monthSubTitle').textContent = new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString(undefined,{month:'long', year:'numeric'});
      document.getElementById('monthModal').style.display = 'flex';
    });
    monthCloseBtn.addEventListener('click', ()=>{ monthModal.style.display='none'; });
    monthModal.addEventListener('click', (e)=>{ if (e.target === monthModal) monthModal.style.display='none'; });

    function limitPct(pure, limit){ if (!limit) return '—'; return Math.round((pure/limit)*100)+'%'; }

    async function fetchMonthRowsSafe(uid, year, monthIndex){
      const monthStr = year + '-' + String(monthIndex+1).padStart(2,'0');
      const daysInMonth = new Date(year, monthIndex+1, 0).getDate();
      const rows = Array.from({length:daysInMonth}, (_,i)=>({ day:i+1, dateStr: `${monthStr}-${String(i+1).padStart(2,'0')}`, total_pure_ml:0, total_ml:0 }));

      try{
        const startStr = `${monthStr}-01`;
        const endStr   = `${monthStr}-31`;
        const cg = query(
          collectionGroup(db, 'users'),
          where('uid','==', uid),
          where('dateStr','>=', startStr),
          where('dateStr','<=', endStr),
          orderBy('dateStr','asc')
        );
        const snap = await getDocs(cg);
        snap.forEach(d=>{
          const x = d.data();
          if (!x.dateStr) return;
          const ds = x.dateStr;
          const idx = parseInt(ds.slice(-2), 10) - 1;
          if (idx>=0 && idx<rows.length && typeof x.total_pure_ml === 'number'){
            rows[idx].total_pure_ml = Math.max(0, x.total_pure_ml||0);
            rows[idx].total_ml = Math.max(0, x.total_ml||0);
          }
        });
        return rows;
      } catch{
        const promises = rows.map(async (r)=>{
          const ref = doc(db,'daily_alc_totals', r.dateStr, 'users', uid);
          const ds  = await getDoc(ref);
          if (ds.exists()){
            const x = ds.data();
            r.total_pure_ml = Math.max(0, x.total_pure_ml||0);
            r.total_ml       = Math.max(0, x.total_ml||0);
          }
          return r;
        });
        return Promise.all(promises);
      }
    }

    /* ==== Инициализация UI ==== */
    renderBeverages();
    updateFactorHint();
    renderHourChart();
    drawDonut();
    requestAnimationFrame(()=>{ const theme=(localStorage.getItem('theme_alc')||'classic'); applyTheme(theme,'local'); });
  </script>
</body>
</html>
